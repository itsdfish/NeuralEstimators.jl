<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>More complicated example · NeuralEstimators.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="NeuralEstimators.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../">NeuralEstimators.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../motivation/">Motivation</a></li><li><span class="tocitem">Workflow</span><ul><li><a class="tocitem" href="../overview/">Overview</a></li><li><a class="tocitem" href="../simpleexample/">Simple example</a></li><li class="is-active"><a class="tocitem" href>More complicated example</a></li><li><a class="tocitem" href="../advancedusage/">Advanced usage</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../API/core/">Core functions</a></li><li><a class="tocitem" href="../../API/simulation/">Data simulation</a></li><li><a class="tocitem" href="../../API/utility/">Utility functions</a></li><li><a class="tocitem" href="../../API/">Index</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Workflow</a></li><li class="is-active"><a href>More complicated example</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>More complicated example</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/msainsburydale/NeuralEstimators.jl/blob/main/docs/src/workflow/morecomplicatedexample.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="More-complicated-example"><a class="docs-heading-anchor" href="#More-complicated-example">More complicated example</a><a id="More-complicated-example-1"></a><a class="docs-heading-anchor-permalink" href="#More-complicated-example" title="Permalink"></a></h1><p>In this example, we&#39;ll consider a standard spatial model, the linear Gaussian-Gaussian model,</p><p class="math-container">\[Z_i = Y(\mathbf{s}_i) + \epsilon_i, \quad  i = 1, \dots, n,\]</p><p>where <span>$\mathbf{Z} \equiv (Z_1, \dots, Z_n)^\top$</span> are data observed at locations <span>$\{\mathbf{s}_1, \dots, \mathbf{s}_n\} \subset \mathcal{D}$</span>, <span>$Y(\cdot)$</span> is a spatially-correlated mean-zero Gaussian process, and <span>$\epsilon_i \sim \rm{N}(0, \sigma^2_\epsilon)$</span> is Gaussian white noise with <span>$\sigma^2_\epsilon$</span> the measurement-error variance parameter. An important component of the model is the covariance function, <span>$C(\mathbf{s}, \mathbf{u}) \equiv \rm{cov}(Y(\mathbf{s}), Y(\mathbf{u}))$</span>, for <span>$\mathbf{s}, \mathbf{u} \in \mathcal{D}$</span>, which is the primary mechanism for capturing spatial dependence. Here, we use the popular isotropic Matérn covariance function,</p><p class="math-container">\[ C(\mathbf{h}) = \sigma^2 \frac{2^{1 - \nu}}{\Gamma(\nu)} \left(\frac{\|\mathbf{h}\|}{\rho}\right) K_\nu \left(\frac{\|\mathbf{h}\|}{\rho}\right),\]</p><p>where <span>$\sigma$</span> is the marginal variance parameter, <span>$\Gamma(\cdot)$</span> is the gamma function, <span>$K_\nu(\cdot)$</span> is the Bessel function of the second kind of order <span>$\nu$</span>, and <span>$\rho &gt; 0$</span> and <span>$\nu &gt; 0$</span> are the range and smoothness parameters, respectively. We follow the common practice decision to fix <span>$\sigma$</span> to 1, and we also fix <span>$\nu = 1$</span> for simplicity. This leaves two unknown parameters that need to be estimated: <span>$\mathbf{\theta} \equiv (\sigma_\epsilon, \rho)^\top$</span>.</p><p>The invariant model objects in this example are the prior distribution, the spatial locations, and the distance matrix. We&#39;ll assume prior independence between the parameters with log-uniform margins. We&#39;ll take our spatial domain of interest, <span>$\mathcal{D}$</span>, to be <span>$[0, 9] \times [0, 9]$</span>, and we&#39;ll simulate data on a regular grid with neighbours in each dimension separated by 1 unit.</p><pre><code class="nohighlight hljs">using NeuralEstimators
using Distributions
Ω = (
 	σₑ = LogUniform(0.05, 0.5),
	ρ  = LogUniform(2, 6)
)
S = expandgrid(1:9, 1:9)
S = Float32.(S)
D = pairwise(Euclidean(), S, S, dims = 1)
ξ = (Ω = Ω, S = S, D = D)</code></pre><p>Next, we define a subtype of <a href="../../API/core/#NeuralEstimators.ParameterConfigurations"><code>ParameterConfigurations</code></a>. For the current model, Cholesky factors of covariance matrices are a key intermediate object needed for data simulation, so they are included in addition to the compulsory field <code>θ</code>.</p><pre><code class="nohighlight hljs">struct Parameters &lt;: ParameterConfigurations
 	θ
	chols
end</code></pre><p>We then define a <code>Parameters</code> constructor, returning a <code>Parameters</code> object with <code>K</code> parameters and corresponding Choleksy factors: Below, we employ the function <a href="../../API/simulation/#NeuralEstimators.maternchols"><code>maternchols(D, ρ, ν)</code></a>.</p><pre><code class="nohighlight hljs">function Parameters(ξ, K::Integer)

 Ω  = ξ.Ω
 σₑ = rand(Ω.σₑ, 1, K)
 ρ  = rand(Ω.ρ, 1, K)
 θ  = vcat(σₑ, ρ)

 chols = maternchols(ξ.D, ρ, 1)

 Parameters(ξ, chols)
end</code></pre><p>Next, we implicitly define the statistical model by overloading <a href="../../API/core/#NeuralEstimators.simulate"><code>simulate</code></a>:</p><pre><code class="nohighlight hljs">import NeuralEstimators: simulate
function simulate(parameters::Parameters, ξ, m::Integer)

	L = parameters.chols
	n = size(L, 1)
	K = size(parameters, 2)

	# For the kth parameter configuration, extract the corresponding Cholesky
	# factor, initialise an array to store the m replicates, and simulate from
	# the model:
	Z = map(1:K) do k
		Lₖ = L[:, :, k]
		z = similar(Lₖ, n, m)
		for i ∈ 1:m
			z[:, i] = Lₖ *  randn(T, n) + σₑ * randn(T, n)
		end
		return z
	end

	# Convert fields to a square domain and add a singleton dimension for
	# compatibility with Flux:
	@assert isqrt(n) == sqrt(n)
	Z = reshape.(Z, isqrt(n), isqrt(n), 1, :)  

	return Z
end</code></pre><p>We then choose an architecture for modelling ψ(⋅) and ϕ(⋅) in the Deep Set framework, and initialise the neural estimator as a <a href="../../API/core/#NeuralEstimators.DeepSet"><code>DeepSet</code></a> object. Note that functions for defining architectures based on the number of parameters in the statistical model, p, can be useful when working with several models.</p><pre><code class="nohighlight hljs">function architecture(p)

 ψ = Chain(
	 Conv((10, 10), 1 =&gt; 32,  relu),
	 Conv((5, 5),  32 =&gt; 64,  relu),
	 Conv((3, 3),  64 =&gt; 128, relu),
	 Flux.flatten,
	 Dense(128, 256, relu)
	 )

 ϕ = Chain(
	 Dense(256, 128, relu),
	 Dense(128, 64, relu),
	 Dense(64, 32, relu),
	 Dense(32, p),
	 x -&gt; exp.(x)
 )

 return ψ, ϕ
end

p = 2
ψ, ϕ = architecture(p)
θ̂ = DeepSet(ψ, ϕ)</code></pre><p>Next, we train the neural estimator using <a href="../../API/core/#NeuralEstimators.train"><code>train</code></a>. For this model, generating <code>Parameters</code> is somewhat expensive due to computation of Choleksy factors. Hence, it can be computationally advantageous to keep the training and validation parameter sets fixed during training, and this is achieved by providing these sets to <a href="../../API/core/#NeuralEstimators.train"><code>train</code></a>:</p><pre><code class="nohighlight hljs">θ_train = Parameters(ξ, 5000)
θ_val   = Parameters(ξ, 500)
θ̂ = train(θ̂, ξ, Parameters, m = 10)</code></pre><p>Note that the above set sizes may be too low to obtain an optimal estimator and, with the current implementation, we are somewhat restricted to using modest set sizes: For a general way to cope with this challenge, see <a href="../advancedusage/#Sharing-intermediate-objects-between-parameter-configurations">Sharing intermediate objects between parameter configurations</a>.</p><p>Irrespective of the model, the functions <a href="../../API/core/#NeuralEstimators.estimate"><code>estimate</code></a> and <a href="../../API/core/#Base.merge-Tuple{Estimates}"><code>merge</code></a> are used as described previously.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../simpleexample/">« Simple example</a><a class="docs-footer-nextpage" href="../advancedusage/">Advanced usage »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.19 on <span class="colophon-date" title="Thursday 7 July 2022 11:54">Thursday 7 July 2022</span>. Using Julia version 1.7.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
